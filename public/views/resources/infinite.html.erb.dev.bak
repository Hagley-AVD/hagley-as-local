<a name="main" title="<%= t('internal_links.main') %>"></a>

<div class="row">
  <%= render partial: 'shared/breadcrumbs' %>
</div>

<div id="main-content" class="row">
  <div class="information col-sm-7">
    <%= render partial: 'shared/idbadge', locals: {:result => @result, :props => { :full => true} } %>
  </div>
  <div class="page_actions col-sm-5 right">
    <%= render partial: 'shared/page_actions', locals: {:record => @result, :title =>  @result.display_string, :url => request.fullpath, :cite => @result.cite } %>
  </div>
</div>

<%= render partial: 'resources/resource_alltabs' %>

<%= javascript_include_tag "#{@base_url}/assets/javascripts/legacy-tree.js" %>

<%= render partial: 'resources/fa_toc', locals: {:result => @result} %>




	<script src="/assets/javascripts/bootstrap-dropdown.js"/>
	<script>
		$('.dropdown-toggle').dropdown()
	</script>

<div class="row feed-container" id="tabs">
  <div class="infinite-record-wrapper col-sm-12 col-md-12 col-lg-10" id="center-page">

<nav class="infinite-record-context">
      <div class="infinite-record-context-affix">
        <a href="#main-content" aria-hidden="true" class="infinite-record-context-resource" style="padding-left: 45px;">
          <span class="infinite-record-context-resource-back-to-top">
            <i aria-hidden="true" class="fa fa-chevron-up"></i> <span>Return to top</span>
          </span>
          <span class="infinite-record-context-resource-title">
	  	<h1><%= @result.display_string %></h1> Identifier: <%= @result.identifier %>
          </span>
        </a>
      </div>
    </nav>


      <div class="infinite-record-container">
          <div class="root">
              <% waypoint_size = 100 %>
              <% @ordered_records.each_slice(waypoint_size).each_with_index do |refs, i| %>
                  <div class="waypoint" data-waypoint-number="<%= i %>" data-waypoint-size=<%= waypoint_size %> data-uris="<%= refs.map {|r| r['ref']}.join(';') %>">&nbsp;</div>
                  <% refs.each do |record|%>
                  <div class="recordplaceholder" id="<%= record["ref"]%>"></div>
                    <% if record["level"] == "series" %>
                      <% p_ref = record["ref"] %>
  <script>$("ul.toc > li > ul.toc-sdi").append('<li><a data-uri="<%= record['ref'] %>">Please wait...</a></li>');</script>
                    <% end %>
                  <% end %>
                  </div>
              <% end %>
          </div>

          </div>
      </div>
      <div class="loader col-sm-offset-3 col-xs-offset-3"><span>Loading. Please Wait...</span></div>


<script>
async function createWaypointLoader() {
  var loader = new WaypointLoader('<%= url_for(:action => :show) %>/infinite',
                                  $('.infinite-record-wrapper'),
                                  <%= @ordered_records.length %>,
                                  function() {
                                  });
  
  console.log('Added waypoint loader')
  /* NOTE: This just here for debugging... */
  window.loader = loader;
}
 var syncer = new TreeSync('<%= params[:rid]%>');
 window.syncer = syncer;

  var scroll = new InfiniteScroll('<%= url_for(:action => :show) %>/infinite',
                                  $('.infinite-record-wrapper'),
                                  <%= @ordered_records.length %>,
                                  function() {
                                      syncer.infiniteScrollIsReady(scroll);
                                  });

/* NOTE: This just here for debugging... */
 window.scroller = scroll;

 var tree = new LargeTree(new TreeDataSource('<%= url_for(:action => :show) %>/tree'),
                          $('.infinite-tree-view'),
                          '<%= @root_uri %>',
                          true,
                          new SimpleRenderer(),
                          function() {
                              syncer.treeIsReady(tree);
                          },
                          function(current_node, tree) {
                            tree.expandNode(current_node);
                          });

window.tree = tree;
</script>

<script>
  // handle clicks on tree items
  $('.infinite-record-wrapper').on('click', '.infinite-record-record a.record-title', function(event) {
      // update the hash so browser-back returns user to the record they clicked
      var $record = $(this).closest('.infinite-record-record');
      var uri = $record.data('uri');
      var tree_id = TreeIds.uri_to_tree_id(uri);
      location.hash = '#tree::'+tree_id;

      return true;
  });
</script>


<%= render partial: 'shared/modal_actions' %>
<%#= javascript_include_tag "https://code.jquery.com/jquery-3.6.3.min.js" %>
<%#= javascript_include_tag "#{@base_url}/assets/javascripts/toc-builder.js" %>
